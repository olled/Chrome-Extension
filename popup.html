<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Projectplace for Chrome</title>
	<link rel="stylesheet" href="/bootstrap/bootstrap.min.css">
	<link rel="stylesheet" href="local.css">

	<script language="javascript" type="text/javascript" src="jquery.js"></script>
	<script language="javascript" type="text/javascript" src="icanhaz/icanhaz.min.js"></script>
	<script language="javascript" type="text/javascript" src="spin/spin.min.js"></script>
	
	<script language="javascript" type="text/javascript" src="bootstrap/js/bootstrap-scrollspy.js"></script>
	<script language="javascript" type="text/javascript" src="bootstrap/js/bootstrap-twipsy.js"></script>
	<script language="javascript" type="text/javascript" src="bootstrap/js/bootstrap-popover.js"></script>

	<script type="text/javascript" src="oauth/chrome_ex_oauthsimple.js"></script>
	<script type="text/javascript" src="oauth/chrome_ex_oauth.js"></script>

	<script language="javascript" src="pp-scripts/projectplace-api-calls.js" type="text/javascript"></script>
	<script language="javascript" src="pp-scripts/projectplace-view-controller.js" type="text/javascript"></script>
	<script language="javascript" src="pp-scripts/projectplace-me-information.js" type="text/javascript"></script>
	<script language="javascript" src="pp-scripts/projectplace-interface-eventhandler.js" type="text/javascript"></script>
	<script language="javascript" src="pp-scripts/projectplace-utils.js" type="text/javascript"></script>
	
	
	<!--
		mainView: the start view, two coll 
	-->
	<script id="mainView" type="text/html">
		<div class="hero-unit" id="trending">
          <h1>Trending</h1>
		  	<blockquote>
			<p id="trendingPost">{{trendingpost}}.</p>
			<small id="trendingWhoUpdatesDates">{{ trendingwho }} {{nrofupdate}} {{lastdate}}</small>
			</blockquote>
        </div>
		 <p class="get-involved"><a id="getInvolved" class="btn success big" view="{{view}}" goto="{{conversationId}}" onclick="mainViewNavigation.go(event);">Get involved &raquo;</a></p>
		  <ul class="pills small">
			  <li class="{{commentsViewActive}}"><a href="#" onclick="return views.mainView(mainViewConfig.TRENDINGBYCOMMENTS);">By nr of comments</a></li>
			  <li class="{{linksViewActive}}"><a href="#" onclick=" return views.mainView(mainViewConfig.TRENDINGBYLIKES);">By nr of Likes</a></li>
		  </ul>
		<hr />
	  	<div class="row">
          {{>fournew}}
        </div>	
	</script>
	
	<!-- Partial via {{>fournew}} -->
	<script id="fournew" class="partial" type="text/html">
		<div class="span6">
			{{conversationsOne}}
			<p><small>{{conversationsOneWho}}</small></p>
			<p><a class="btn" view="{{view}}" goto="{{conversationsOneId}}" onclick="mainViewNavigation.go(event);" href="#">View details &raquo;</a></p>
		</div>
		<div class="span5">
			{{conversationsTwo}}
			<p><small>{{conversationsTwoWho}}</small></p>
			<p><a class="btn" view="{{view}}" goto="{{conversationsTwoId}}" onclick="mainViewNavigation.go(event);" href="#">View details &raquo;</a></p>
		</div>
		<div class="span5">
			{{conversationsThree}}
			<p><small>{{conversationsThreeWho}}</small></p>
			<p><a class="btn" view="{{view}}" goto="{{conversationsThreeId}}" onclick="mainViewNavigation.go(event);" href="#">View details &raquo;</a></p>
		</div>
	</script>
	
	<!--
		aboutView: Who am I who created this..One coll view. 
	-->
	<script id="aboutView" type="text/html">
	  	<div class="row">
          <div class="page-header">
          	<h1>About<small> - Olle Dahlstršm</small></h1>
	       </div>
             <div class="row">
             	
				<div class="span3"> 
				  <ul class="media-grid">
				  <li>
				    <a href="#" id="me" rel="popover" data-content="Yeah, this is me" data-original-title="Olle Dahlstrom">
				     <img class="thumbnail" src="http://dl.dropbox.com/u/23070527/chrome-ext-img/olle.jpg" alt="Olle">
				    </a>
				  </li>
				 </ul>
				 </div>
				 <div class="span8">
					My name is Olle Dahlstršm, and I created this since I want to be able to browse conversations, 
					documents etc from Projectplace right in my browser.
					I do not want to login, I want it where I am, in my browser.
				<p />
				<p><small>If you see anything strange that does not work, or would like to give me some feedback(possitiv is more fun 
				the negative) or anything, please contact me @ <a href="mailto:olle.dahlstrom@gmail.com">Olle Dahlstrom @ gmail</a>
				</small></p>
				</div>
           </div>
        </div>
	 </script>
	
	
	<!--
		navigation: the main top navigation
	-->
	<script id="navigation" type="text/html">
		<li><a href="#allconversations" view="{{allconversations}}" goto="none" onclick="mainViewNavigation.go(event);">Conversations <span>{{ nrOfUpDates }}</span></a></li>
		<li><a href="#allprojects">Projects</a></li>
		<li><a href="#allpeople" view="{{peoplesView}}" goto="none" onclick="mainViewNavigation.go(event);">People</a></li>
        <li><a href="#about" view="{{aboutMe}}" goto="none" onclick="mainViewNavigation.go(event);">About/Contact</a></li>
	</script>
	
	<!--
		Single Conversations view
	-->
	<script id="singleNavigation" type="text/html">
	 <div class="page-header">
          <h1>Post by {{authorName}} <small>{{lastPost}}</small></h1>
        </div>
        <div class="row">
          <div class="span10">
          	<button class="btn success" type="like">Like</button>
            {{postMessage}} 
			<p><small>
				<a href="#" onclick="alert('not implemented');" title="User page">{{authorName}}</a> - {{title}} {{organisation}}
				</small>
			</p>
			<form>
			  <div class="clearfix">
		         <div class="input">
		           <textarea class="xxlarge" id="postComment" rows="4"></textarea>
		           <span class="help-block">
		              Add your own saying in this matter
		            </span>
	            </div>
				<div class="actions">
	            	<input type="submit" class="btn primary" value="Post your comment">&nbsp;<button type="reset" class="btn">Cancel</button>
          		</div>
			   </div>
			</form>
          
          </div>
          <div class="span4 commentsview" id="singleConversationsComments">
            <h4>Comments</h4>
			{{comments}}
          </div>
        </div>
	</script>
	
	<!--One comment in the single conversations view -->
	<script id="singleNavigationPost" type="text/html">
	  <div>
	  	{{message}}
		<p><small>{{who}} - {{time}}</small></p>
	  </div>
	  
	 </script>
	 
	 
	<!--
		All Conversatsion View
	-->
	<script id="allConversationsView" type="text/html">
	 	<div id="allconversations" class="page-header">
          <h1>All Conversations<small>- found in Projectplace</small></h1>
        </div>
	</script>
	
	<!--
		One row in all Conversations View
	-->
	<script id="rowAllConversationsView" type="text/html">
	<div class="row">
	          <div class="span15" view="{{view}}" goto="{{conversationId1}}" onclick="mainViewNavigation.go(event);">
	            {{row1Message}}
				<p><small>{{who1}} - {{time1}}</small></p>
	          </div>
			  <div class="span15" view="{{view}}" goto="{{conversationId2}}" onclick="mainViewNavigation.go(event);">
	            {{row2Message}}
				<p><small>{{who2}} - {{time2}}</small></p>
	          </div>
			  <div class="span15" view="{{view}}" goto="{{conversationId3}}" onclick="mainViewNavigation.go(event);">
	            {{row3Message}}
				<p><small>{{who3}} - {{time3}}</small></p>
	          </div>
			  <div class="span15" view="{{view}}" goto="{{conversationId4}}" onclick="mainViewNavigation.go(event);">
	            {{row4Message}}
				<p><small>{{who4}} - {{time4}}</small></p>
	          </div>
		</div>
	</script>
	
	<!--
		All Peoples View heading
	-->
	<script id="allPeoplesView" type="text/html">
	 	<div class="page-header">
          <h1>Colleagues<small> - found in Projectplace</small></h1>
        </div>
	</script>
	
	<!--
		One row in all Peoples View
	-->
	<script id="rowAllPeoplePage" type="text/html">
	<div class="row">
	          <ul class="media-grid">
				  <li>
				      <a href="#" id="test" rel="popover" data-content="And here's some amazing content." data-original-title="A title">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				  <li>
				    <a href="#">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				  <li>
				    <a href="#">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				  <li>
				    <a href="#">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				  <li>
				    <a href="#">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				  <li>
				    <a href="#">
				      <img class="thumbnail" src="http://placehold.it/90x90" alt="">
				    </a>
				  </li>
				</ul>
		</div>
	</script>
	
	<script language="javascript" type="text/javascript">
		var initialLoad = true;
		clearBadgeText();
	
		var background = chrome.extension.getBackgroundPage();
		var user = background.getViewControll().user;
		
		function _showTrendingObject(view, trendingId){
			runSpinner.close();
			if (view == 'by-comments') {
				var trendingObject = user.getTrendingConversation();
				var coworker = user.getSpecificCoWorker(trendingObject.posts[0].author_id);
				var lastPost = toLocaleDateString(trendingObject.last_post_time);
				$('#trendingPost').html(trendingObject.posts[0].message);
				$('#trendingWhoUpdatesDates').html(coworker.sort_name + ' || Nr of Comments: '+ (trendingObject.post_count -1) + ' - '+lastPost )
				
				document.getElementById('getInvolved').setAttribute('goto',trendingId);
			}
		}
		
		function _displayTrendingCommentsBy(trendingId){
			var arrOfFourConversations = user.getTopFourConversationsByDate();
			var mainConf = {
				trendingpost: '',
				trendingwho: '',
				nrofupdate: '',
				lastdate: '',
				conversationId: '',
				view: mainViewConfig.SINGLECONVERSATION,
				commentsViewActive: 'active',
				linksViewActive: '',
				conversationsOne: arrOfFourConversations[0].posts[0].message,
				conversationsOneWho: user.getSpecificCoWorker(arrOfFourConversations[0].posts[0].author_id).sort_name,
				conversationsOneId: arrOfFourConversations[0].id,
				conversationsTwo : arrOfFourConversations[1].posts[0].message,
				conversationsTwoWho: user.getSpecificCoWorker(arrOfFourConversations[1].posts[0].author_id).sort_name,
				conversationsTwoId: arrOfFourConversations[1].id,
				conversationsThree : arrOfFourConversations[2].posts[0].message,
				conversationsThreeWho: user.getSpecificCoWorker(arrOfFourConversations[2].posts[0].author_id).sort_name,
				conversationsThreeId: arrOfFourConversations[2].id
			};
			var main = ich.mainView(mainConf)
			$('#content').empty();
			$('#content').append(main);
			runSpinner.run();
			window.setTimeout('_showTrendingObject("by-comments",'+trendingId+')',2000);
			
		}
		function _displayTrendingLikedBy(trendingId){
			var arrOfFourConversations = user.getTopFourConversationsByDate();
			var trendingObject = user.getTrendingConversation();
			
			var coworker = user.getSpecificCoWorker(trendingObject.posts[0].author_id);
			
			var lastPost = toLocaleDateString(trendingObject.last_post_time);
			var likedByNr = 0;
			for (var like in trendingObject.liked_by){
				likedByNr++;
			}
			
			var mainConf = {
				trendingpost: trendingObject.posts[0].message,
				trendingwho: coworker.sort_name,
				nrofupdate: 'Nr of Likes: '+ likedByNr,
				lastdate: lastPost,
				conversationId: trendingId,
				view: mainViewConfig.SINGLECONVERSATION,
				commentsViewActive: '',
				linksViewActive: 'active',
				conversationsOne: arrOfFourConversations[0].posts[0].message,
				conversationsOneWho: user.getSpecificCoWorker(arrOfFourConversations[0].posts[0].author_id).sort_name,
				conversationsOneId: arrOfFourConversations[0].id,
				conversationsTwo : arrOfFourConversations[1].posts[0].message,
				conversationsTwoWho: user.getSpecificCoWorker(arrOfFourConversations[1].posts[0].author_id).sort_name,
				conversationsTwoId: arrOfFourConversations[1].id,
				conversationsThree : arrOfFourConversations[2].posts[0].message,
				conversationsThreeWho: user.getSpecificCoWorker(arrOfFourConversations[2].posts[0].author_id).sort_name,
				conversationsThreeId: arrOfFourConversations[2].id
			};
			var main = ich.mainView(mainConf);
			$('#content').empty();	
			$('#content').append(main);
		}
		var runSpinner = {
			_spinner: null,
			run: function(_target){
				var opts = {
					lines: 12, // The number of lines to draw
					length: 7, // The length of each line
					width: 2, // The line thickness
					radius: 10, // The radius of the inner circle
					color: '#000', // #rbg or #rrggbb
					speed: 1, // Rounds per second
					trail: 100, // Afterglow percentage
					shadow: true // Whether to render a shadow
				};
				var target = (!_target?document.getElementById('trending') : document.getElementById(_target));
				runSpinner._spinner = new Spinner(opts).spin(target);
			},
			close: function(){
				runSpinner._spinner.stop();
			}
		}

		var views = {
			mainView: function(trendingBy){
				runSpinner.run();
				if (trendingBy == mainViewConfig.TRENDINGBYCOMMENTS) {
					var trendingId = user.getTrendingConversationOnCommentsId();
					user.setTrendingConversationObject(trendingId);	
					var unReadItems = user.getNewConversationsCount();					
					
					
					if (!initialLoad) {
						
						$('#nav').empty();
					}
					else{
						initialLoad = false;
					}
					_displayTrendingCommentsBy(trendingId);
					var navConf = {
						nrOfUpDates: '['+unReadItems+']',
						allconversations: mainViewConfig.CONVERSATIONS,
						peoplesView: mainViewConfig.ALLPEOPLESVIEW,
						aboutMe: mainViewConfig.ABOUTME
						
					};
					
					var nav = ich.navigation(navConf);
					$('#nav').append(nav);
					
					return false;
				}
				else if (trendingBy == mainViewConfig.TRENDINGBYLIKES) {
					var trendingId = user.getTrendingConversationOnLikesId();
					user.setTrendingConversationObject(trendingId);	
					
					window.setTimeout('_displayTrendingLikedBy('+trendingId+');',2500)
					
					return false;
				}
			},
			singleConversationsView: function(conversationsId)
			{
				$('#content').empty();
				function _presentConversation(conversationObject){
					
					var coworker = user.getSpecificCoWorker(conversationObject.posts[0].author_id);
			
					var lastPost = toLocaleDateString(conversationObject.last_post_time);
					var likedByNr = 0;
					for (var like in conversationObject.liked_by){
						likedByNr++;
					}
					
					var comments = '';
					
					var singleNavConf = {
						authorName: coworker.sort_name,
						organisation: coworker.organisation_name,
						title: coworker.title,
						lastPost: lastPost,
						postMessage: conversationObject.posts[0].message,
						comments: comments
					};
					var singelNavigation = ich.singleNavigation(singleNavConf)
					$('#content').append(singelNavigation);
					
					runSpinner.run('singleConversationsComments');
					
					function _displayComments(t, xhr){
						var singleConversationWithComments = JSON.parse(t);
						var comments = singleConversationWithComments.posts;
						comments.sort(sort_by('created_time', true, parseInt));
						for(var i = 0; i < comments.length-1; i++){
							singleConf = {
								message:comments[i].message,
								who:user.getSpecificCoWorker(comments[i].author_id).sort_name,
								time: toLocaleDateString(comments[i].created_time)
							}
							$('#singleConversationsComments').append(ich.singleNavigationPost(singleConf));
						}
						runSpinner.close();
					}
					user.getSpecificConversationComments(conversationsId, _displayComments);	
				}
				user.getSpecificConversation(conversationsId, _presentConversation);
			},
			allConversationsView: function(){
				$('#content').empty();
				$('#content').append(ich.allConversationsView({}));
				
				var allConversations = user.getConversations();
				allConversations.sort(sort_by('last_post_time', true, parseInt));
				
				function _createRowOfConversations(){
					for(var i = 0; i < allConversations.length; i+=4){
						rowConfig = {
							view: mainViewConfig.SINGLECONVERSATION,
							
							conversationId1:allConversations[i].id,  
				            row1Message:allConversations[i].posts[0].message,
							who1: user.getSpecificCoWorker(allConversations[i].posts[0].author_id).sort_name,
							time1: toLocaleDateString(allConversations[i].last_post_time),
							
							conversationId2:allConversations[i+1].id,  
				            row2Message:allConversations[i+1].posts[0].message,
							who2: user.getSpecificCoWorker(allConversations[i+1].posts[0].author_id).sort_name,
							time2: toLocaleDateString(allConversations[i+1].last_post_time),
							
							conversationId3:allConversations[i+2].id,  
				            row3Message:allConversations[i+2].posts[0].message,
							who3: user.getSpecificCoWorker(allConversations[i+2].posts[0].author_id).sort_name,
							time3: toLocaleDateString(allConversations[i+2].last_post_time),
							
							conversationId4:allConversations[i+3].id,  
				            row4Message:allConversations[i+3].posts[0].message,
							who4: user.getSpecificCoWorker(allConversations[i+3].posts[0].author_id).sort_name,
							time4: toLocaleDateString(allConversations[i+3].last_post_time)
						}
						$('#content').append(ich.rowAllConversationsView(rowConfig));	
					}
				}
				_createRowOfConversations();
				
				
				//$('body').scrollSpy('refresh');
			},
			allPeoplesView: function(){
				$('#content').empty();
				$('#content').append(ich.allPeoplesView({}));
				$('#content').append(ich.rowAllPeoplePage({}));
				
				var tOptions = {
					content: 'A little test to see if we can get this text',
					title: 'The heading!'
				}
				$('#test').popover({});
				
			},
			singleUserView: function(){
			},
			projectsView: function(){
				
			},
			aboutView: function(){
				$('#content').empty();
				$('#content').append(ich.aboutView({}));
				$('#me').popover({});
			},
			contactsView: function(){
				
			}
		}
		
		$('body > .topbar').scrollSpy()
		
		window.onload = function(){
			views.mainView(mainViewConfig.TRENDINGBYCOMMENTS);
		}
	</script>
	

  </head>
  <body>
  	<div class="topbar" data-scrollspy="scrollspy">
      <div class="topbar-inner">
        <div class="container-fluid">
          <a class="brand" href="#" onclick="views.mainView(mainViewConfig.TRENDINGBYCOMMENTS);">Chrome for Projectplace</a>
          <ul class="nav" id="nav">
			
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content" id="content">
      </div>

      <footer>
        <p><small><a href="http://github.com/olled/" target="_blank">Wanna help develop this one?</a></small></p>
      </footer>

    </div>
  </body>
</html>